<?php

/**
 * @file
 * Primary module hooks for Rating Scorer module.
 */

/**
 * Implements hook_help().
 */
function rating_scorer_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.rating_scorer':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The Rating Scorer module provides a calculator for combining ratings and number of ratings using various scoring methods.') . '</p>';
      $output .= '<h3>' . t('Uses') . '</h3>';
      $output .= '<dl>';
      $output .= '<dt>' . t('Calculating scores') . '</dt>';
      $output .= '<dd>' . t('Use the calculator at <a href=":calculator">Rating Scorer</a> to see how different scoring methods combine rating values with the number of ratings.', [':calculator' => '/admin/config/rating-scorer']) . '</dd>';
      $output .= '<dt>' . t('Configuring defaults') . '</dt>';
      $output .= '<dd>' . t('Users with the "Administer rating scorer settings" permission can configure default parameters at <a href=":settings">Rating Scorer Settings</a>.', [':settings' => '/admin/config/rating-scorer/settings']) . '</dd>';
      $output .= '</dl>';
      return $output;
  }
}

/**
 * Implements hook_theme().
 */
function rating_scorer_theme($existing, $type, $theme, $path) {
  return [
    'rating_scorer' => [
      'variables' => [],
      'template' => 'rating-scorer',
    ],
  ];
}

/**
 * Implements hook_entity_presave().
 *
 * Update rating_score fields when source fields change using the
 * RatingScoreCalculator service.
 */
function rating_scorer_entity_presave(\Drupal\Core\Entity\EntityInterface $entity) {
  if (!($entity instanceof \Drupal\Core\Entity\ContentEntityInterface)) {
    return;
  }

  try {
    $calculator = \Drupal::service('rating_scorer.calculator');
    $calculator->updateScoreFieldsOnEntity($entity);
    
    // Log when scores are updated for debugging
    \Drupal::logger('rating_scorer')->info(
      'Updated rating scores for @type (@bundle)',
      [
        '@type' => $entity->getEntityTypeId(),
        '@bundle' => $entity->bundle(),
      ]
    );
  } catch (\Exception $e) {
    // Log errors for debugging
    \Drupal::logger('rating_scorer')->error(
      'Error updating rating scores: @error',
      ['@error' => $e->getMessage()]
    );
  }
}

/**
 * Helper function to calculate a rating score.
 *
 * @param int $number_of_ratings
 *   The number of ratings.
 * @param float $average_rating
 *   The average rating.
 * @param string $method
 *   The scoring method.
 * @param int $minimum_threshold
 *   The minimum ratings threshold.
 *
 * @return float
 *   The calculated score.
 */
function _rating_scorer_calculate_score($number_of_ratings, $average_rating, $method, $minimum_threshold) {
  switch ($method) {
    case 'bayesian':
      $prior_rating = 2.5;
      return ($number_of_ratings * $average_rating + $minimum_threshold * $prior_rating) / ($number_of_ratings + $minimum_threshold);

    case 'wilson':
      $normalized_rating = $average_rating / 5;
      $z = 1.96;
      if ($number_of_ratings == 0) {
        return 0;
      }
      $phat = $normalized_rating;
      $denominator = 1 + $z * $z / $number_of_ratings;
      $center = ($phat + $z * $z / (2 * $number_of_ratings)) / $denominator;
      $margin = $z * sqrt(($phat * (1 - $phat) / $number_of_ratings) + ($z * $z / (4 * $number_of_ratings * $number_of_ratings))) / $denominator;
      return max(0, $center - $margin);

    case 'weighted':
    default:
      return $average_rating * log($number_of_ratings + 1);
  }
}

/**
 * Implements hook_views_pre_render().
 */
function rating_scorer_views_pre_render(\Drupal\views\ViewExecutable $view) {
  // Check if the view has rating_score sort criteria.
  if (empty($view->sort) || empty($view->result)) {
    return;
  }

  $rating_score_sort = NULL;
  foreach ($view->sort as $sort) {
    if ($sort->getPluginId() === 'rating_score') {
      $rating_score_sort = $sort;
      break;
    }
  }

  if (!$rating_score_sort) {
    return;
  }

  // Find the rating_score field handler.
  $field_handler = NULL;
  foreach ($view->field as $field) {
    if ($field->getPluginId() === 'rating_score') {
      $field_handler = $field;
      break;
    }
  }

  if (!$field_handler) {
    return;
  }

  // Ensure all rows have their scores cached by rendering the field.
  foreach ($view->result as $row) {
    $field_handler->render($row);
  }

  // Sort the current page results based on cached scores.
  usort($view->result, function ($a, $b) use ($rating_score_sort) {
    $score_a = $a->rating_score_value ?? 0;
    $score_b = $b->rating_score_value ?? 0;

    $result = $score_a <=> $score_b;

    // Reverse if descending order.
    if ($rating_score_sort->options['order'] === 'DESC') {
      $result = -$result;
    }

    return $result;
  });
}

/**
 * Implements hook_views_data().
 */
function rating_scorer_views_data() {
  $data = [];

  // Add the rating score field to all entity base tables.
  foreach (\Drupal::entityTypeManager()->getDefinitions() as $entity_type) {
    if ($base_table = $entity_type->getBaseTable()) {
      $data[$base_table]['rating_score'] = [
        'title' => t('Rating Score'),
        'help' => t('Calculate a fair rating score using various scoring methods. Requires two numeric fields: number of ratings and average rating.'),
        'field' => [
          'id' => 'rating_score',
          'no field' => TRUE,
        ],
        'sort' => [
          'id' => 'rating_score',
        ],
      ];
    }
  }

  return $data;
}

